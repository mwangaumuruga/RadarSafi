<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RadarSafi - AI-powered fraud detection and prevention platform for Kenya. Verify suspicious messages, learn about scams, and stay safe online. Understand Swahili and Sheng.">
    <meta name="keywords" content="fraud detection, scam prevention, Kenya, M-Pesa scams, phishing, cybersecurity, AI assistant, RadarSafi">
    <meta name="author" content="RadarSafi">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://radarsafi.netlify.app/">
    <meta property="og:title" content="RadarSafi - Your Digital Security Assistant">
    <meta property="og:description" content="AI-powered fraud detection and prevention. Verify suspicious messages, learn about scams, stay safe online.">
    <meta property="og:image" content="https://radarsafi.netlify.app/assets/images/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://radarsafi.netlify.app/">
    <meta property="twitter:title" content="RadarSafi - Your Digital Security Assistant">
    <meta property="twitter:description" content="AI-powered fraud detection and prevention. Verify suspicious messages, learn about scams, stay safe online.">
    <meta property="twitter:image" content="https://radarsafi.netlify.app/assets/images/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/images/logo.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#10b981">
    
    <title>RadarSafi - AI-Powered Fraud Detection & Prevention</title>

    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Marked.js to render Markdown responses from the AI -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Simple styles for tab content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-2xl overflow-hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6">
            <h1 class="text-3xl font-bold">RADARSAFI</h1>
            <p class="text-lg opacity-90">Your Kenyan Fraud Detection & Prevention Assistant</p>
        </header>

        <!-- API Key Input -->
        <div class="p-4 border-b bg-yellow-50 border-yellow-200">
            <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-1">Enter Your Gemini API Key:</label>
            <input type="password" id="api-key-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Paste your API key here to activate the app">
            <p class="text-xs text-gray-500 mt-1">Your key is used only in your browser and never stored.</p>
        </div>

        <!-- Main Content -->
        <main class="p-4 md:p-6">
            <!-- Tab Buttons -->
            <nav class="flex border-b border-gray-200 mb-6">
                <button data-tab="chat" class="tab-btn active text-blue-600 border-b-2 border-blue-600 py-3 px-4 font-medium">AI Chat</button>
                <button data-tab="verify" class="tab-btn text-gray-500 py-3 px-4 font-medium">Direct Verification</button>
                <button data-tab="quiz" class="tab-btn text-gray-500 py-3 px-4 font-medium">Play & Learn</button>
            </nav>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-50" style="display: none;">
                <div class="flex flex-col items-center">
                    <div class="spinner mb-4"></div>
                    <p class="text-gray-700 font-medium">RadarSafi is thinking.....</p>
                </div>
            </div>

            <!-- Tab 1: AI Chat (Home Tab) -->
            <div id="chat-content" class="tab-content active">
                <p class="text-gray-600 mb-4">Ask about a message, link, or situation. (e.g., "Nimepata message from Naivas, ni legit?" or "Is this TikTok message about 7M USDT real?")</p>
                <div id="chat-history" class="h-80 border border-gray-200 rounded-lg p-4 overflow-y-auto mb-4 bg-gray-50">
                    <!-- Chat messages will appear here -->
                    <div class="text-gray-500 text-center">Chat history will appear here.</div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Type your message...">
                    <button id="chat-send" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-blue-700 transition-colors">Send</button>
                </div>
            </div>

            <!-- Tab 2: Direct Verification Tab -->
            <div id="verify-content" class="tab-content">
                <!-- Sub-tabs for Verification -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button data-subtab="text" class="subtab-btn active text-green-700 border-b-2 border-green-700 pb-2 px-3 text-sm font-medium">Text / Link</button>
                    <button data-subtab="image" class="subtab-btn text-gray-500 pb-2 px-3 text-sm font-medium">Screenshot</button>
                    <button data-subtab="phone" class="subtab-btn text-gray-500 pb-2 px-3 text-sm font-medium">Phone Number</button>
                </div>

                <!-- Verification Results Box -->
                <div id="verify-results" class="border border-gray-200 rounded-lg p-4 bg-gray-50 min-h-[150px]" style="display: none;">
                    <h4 class="font-bold text-lg mb-2 text-gray-800">Analysis Result:</h4>
                    <div id="verify-output" class="prose prose-sm max-w-none"></div>
                </div>

                <!-- Sub-tab Content: Text -->
                <div id="text-subcontent" class="subtab-content active mt-4">
                    <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">Paste suspicious Email, SMS, or WhatsApp message:</label>
                    <textarea id="text-input" rows="5" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., 'Dear customer, your account has been locked. Click http://ncba-verify.net to unlock...'"></textarea>
                    <button id="text-verify-btn" class="mt-3 bg-green-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:bg-green-700 transition-colors">Analyze Text</button>
                </div>

                <!-- Sub-tab Content: Image -->
                <div id="image-subcontent" class="subtab-content mt-4" style="display: none;">
                    <label for="image-input" class="block text-sm font-medium text-gray-700 mb-2">Upload suspicious Screenshot (e.g., WhatsApp promo):</label>
                    <input type="file" id="image-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="image-verify-btn" class="mt-3 bg-green-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:bg-green-700 transition-colors" disabled>Upload & Analyze</button>
                    <img id="image-preview" src="" alt="Image preview" class="mt-4 max-h-60 rounded-lg border border-gray-300" style="display:none;"/>
                </div>

                <!-- Sub-tab Content: Phone -->
                <div id="phone-subcontent" class="subtab-content mt-4" style="display: none;">
                    <label for="phone-input" class="block text-sm font-medium text-gray-700 mb-2">Enter the suspicious Phone Number:</label>
                    <input type="tel" id="phone-input" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., 0712345678">
                    <label for="org-input" class="block text-sm font-medium text-gray-700 mt-4 mb-2">Who did they claim to be? (e.g., NCBA, KPLC, Naivas)</label>
                    <input type="text" id="org-input" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., NCBA Bank">
                    <button id="phone-verify-btn" class="mt-3 bg-green-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:bg-green-700 transition-colors">Check Number (with Google Search)</button>
                </div>
            </div>

            <!-- Tab 3: Play & Learn Tab -->
            <div id="quiz-content" class="tab-content">
                <div id="quiz-container" class="border border-gray-200 rounded-lg p-6">
                    <div id="quiz-question" class="text-xl font-semibold text-gray-800 mb-4"></div>
                    <div id="quiz-options" class="flex flex-col gap-3">
                        <!-- Options will be injected here -->
                    </div>
                    <div id="quiz-feedback" class="mt-5 p-4 rounded-lg bg-gray-50" style="display: none;">
                        <h4 id="feedback-title" class="font-bold text-lg mb-2"></h4>
                        <div id="feedback-text" class="prose prose-sm max-w-none"></div>
                    </div>
                    <button id="next-question-btn" class="mt-4 bg-blue-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition-colors" style="display: none;">Next Question</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 p-6 mt-8 border-t border-gray-200">
            <div class="max-w-4xl mx-auto text-center text-sm text-gray-600">
                <p class="mb-2">
                    <strong>RadarSafi</strong> - Stay Safe, Stay Informed ðŸ‡°ðŸ‡ª
                </p>
                <p class="mb-3">
                    Powered by <a href="https://ai.google.dev/" target="_blank" rel="noopener" class="text-blue-600 hover:underline">Google Gemini AI</a>
                </p>
                <div class="flex justify-center gap-4 text-xs">
                    <a href="https://github.com/mwangaumuruga/radarsafi" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-700">GitHub</a>
                    <span class="text-gray-400">|</span>
                    <a href="https://github.com/mwangaumuruga/radarsafi/issues" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-700">Report Issue</a>
                    <span class="text-gray-400">|</span>
                    <a href="https://github.com/mwangaumuruga/radarsafi/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-700">Contribute</a>
                </div>
                <p class="mt-3 text-xs text-gray-500">
                    Your privacy matters: All processing happens in your browser. No data is stored on our servers.
                </p>
            </div>
        </footer>
    </div>

    <script type="module">
        // --- Gemini API Configuration ---
        // IMPORTANT: This uses the gemini-2.5-flash-preview-09-2025 model.
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        function getApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (!key) {
                alert("Please enter your Gemini API Key first.");
                return null;
            }
            return key;
        }

        const loadingIndicator = document.getElementById('loading-indicator');

        /**
         * Core function to call the Gemini API.
         * This function implements your core AI logic.
         * @param {string} prompt - The user's text prompt.
         * @param {string | null} base64Image - Base64-encoded image string (optional).
         * @param {boolean} useGrounding - Whether to enable Google Search (Agentic AI).
         * @param {string | null} systemInstruction - The persona for the AI (optional).
         */
        async function callGeminiAPI(prompt, base64Image = null, useGrounding = false, systemInstruction = null) {
            const apiKey = getApiKey();
            if (!apiKey) return null;

            loadingIndicator.style.display = 'block';

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;

            let parts = [{ "text": prompt }];

            // Feature Implementation: Upload Screenshot (Multimodality)
            if (base64Image) {
                parts.push({
                    "inlineData": {
                        "mimeType": "image/jpeg", // Assuming JPEG, adjust if needed
                        "data": base64Image
                    }
                });
            }

            let payload = {
                "contents": [{"parts": parts}],
            };

            // Feature Implementation: Agentic AI (Phone Check)
            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
                // Grounding works best with a specific instruction
                payload.systemInstruction = {
                    parts: [{ text: "You are a helpful assistant. Your task is to use Google Search to find factual, up-to-date information to answer the user's query. You must cite your sources." }]
                };
            }

            // Feature Implementation: AI Chat Persona
            if (systemInstruction && !useGrounding) {
                payload.systemInstruction = {
                    parts: [{ text: systemInstruction }]
                };
            }

            try {
                // Implement exponential backoff for retries
                let response;
                let retries = 0;
                const maxRetries = 3;
                let delay = 1000;

                while (retries < maxRetries) {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    }

                    if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, wait and retry
                        console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        retries++;
                    } else {
                        // Other client-side error
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                }

                if (!response.ok) {
                    throw new Error(`API call failed after ${maxRetries} retries.`);
                }

                const result = await response.json();
                
                // Process the response
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    // Extract sources if grounding was used
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                            .filter(src => src.uri && src.title);
                    }
                    
                    return { text, sources };
                } else {
                    console.error("Invalid response structure:", result);
                    return { text: "Sorry, I received an invalid response from the AI. Please check the console.", sources: [] };
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return { text: `An error occurred: ${error.message}. (Check console for details)`, sources: [] };
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // --- Helper: Render Markdown ---
        function renderMarkdown(text) {
            // Basic sanitization: replace potential HTML tags to prevent XSS
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return marked.parse(sanitizedText);
        }

        // --- Tab Switching Logic ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('active', 'text-blue-600', 'border-blue-600');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tab}-content`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // --- Sub-Tab Switching Logic ---
        const subTabButtons = document.querySelectorAll('.subtab-btn');
        const subTabContents = document.querySelectorAll('.subtab-content');

        subTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const subtab = button.dataset.subtab;
                
                subTabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-green-700', 'border-green-700');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('active', 'text-green-700', 'border-green-700');
                
                subTabContents.forEach(content => {
                    content.style.display = 'none';
                    if (content.id === `${subtab}-subcontent`) {
                        content.style.display = 'block';
                    }
                });
                // Hide results when switching subtabs
                document.getElementById('verify-results').style.display = 'none';
            });
        });


        // --- Feature 1: AI Chat ---
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send');
        const chatHistory = document.getElementById('chat-history');
        let chatConversation = []; // Store the conversation history

        // System prompt for the chatbot
        const CHAT_SYSTEM_PROMPT = `You are "RadarSafi", a friendly and helpful Kenyan cybersecurity assistant. Your goal is to help users identify digital fraud and scams.
        - You MUST be able to understand and reply in English, Swahili, and Sheng.
        - Be direct, simple, and encouraging. Assume the user is not a tech expert.
        - When you detect a scam, clearly state "This looks like a scam" (or "Hii inakaa scam") and then explain *why* in simple terms (e.g., "Mismatched link," "Too good to be true," "Urgency").
        - Keep responses concise and easy to read. Use bullet points for steps.`;

        async function handleChatSend() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Add user message to UI
            chatHistory.innerHTML = (chatHistory.innerHTML.includes("Chat history will appear here") ? "" : chatHistory.innerHTML) + 
                `<div class="mb-3"><strong class="text-blue-700">You:</strong><div class="prose prose-sm max-w-none">${renderMarkdown(userMessage)}</div></div>`;
            chatInput.value = "";
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Add user message to conversation history
            chatConversation.push({ "role": "user", "parts": [{ "text": userMessage }] });

            // Call API
            const apiPayload = {
                "contents": chatConversation,
                "systemInstruction": { "parts": [{ "text": CHAT_SYSTEM_PROMPT }] }
            };

            //

